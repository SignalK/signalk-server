ARG REGISTRY="cr.signalk.io"
ARG BASE_IMAGE="24.04-22.x"

FROM ${REGISTRY}/signalk/signalk-server-base:latest-${BASE_IMAGE}

USER node
RUN mkdir -p /home/node/.signalk/ \
  && mkdir -p /home/node/signalk/

WORKDIR /home/node/signalk

RUN npm config rm proxy \
  && npm config rm https-proxy \
  && npm config set fetch-retries 5 \
  && npm config set fetch-retry-mintimeout 60000 \
  && npm config set fetch-retry-maxtimeout 120000 \
  && npm cache clean -f

ARG TAG

# Install locally (not globally) to avoid permission issues
# Copy @signalk packages and @mxtommy/kip to nested location where webapp discovery expects them
RUN npm install signalk-server@$TAG \
  && mkdir -p node_modules/signalk-server/node_modules/@signalk/ \
  && cp -rf node_modules/@signalk/* node_modules/signalk-server/node_modules/@signalk/ \
  && rm -rf node_modules/@signalk/ \
  && mkdir -p node_modules/signalk-server/node_modules/@mxtommy/ \
  && cp -rf node_modules/@mxtommy/kip node_modules/signalk-server/node_modules/@mxtommy/ \
  && rm -rf node_modules/@mxtommy/;

COPY --chown=node:node --chmod=755 docker/startup.sh startup.sh

EXPOSE 3000
WORKDIR /home/node/.signalk
ENTRYPOINT ["/home/node/signalk/startup.sh"]
