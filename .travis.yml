language: node_js
node_js:
  - "lts/*"
sudo: false
env:
  - CXX=g++-4.8
addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - g++-4.8
    - jq
    - fakeroot
    - dpkg
    - libavahi-compat-libdnssd-dev
jobs:
  include:

  - stage: test
    script: npm test

  - stage: build-deb-branch
    before_install:
    - npm install -g node-deb
    before_script:
        - "PACKAGE_VERSION=$(cat package.json | grep version | head -1 | awk -F: '{ print $2 }' | sed 's/[\",]//g' | tr -d '[[:space:]]')"
        - node-deb --verbose -n "signalk-server-${TRAVIS_BRANCH}" -v "${PACKAGE_VERSION}-snapshot-${TRAVIS_BUILD_NUMBER}" -- index.js `find . -maxdepth 1 -type d | grep -v .git | grep -v node_modules | egrep -v '^\.$'`
    script: ls -lh *.deb ; dpkg-deb --info *.deb
    deploy:
      - provider: packagecloud
        repository: signalk-server
        username: SignalK 
        token:
          secure:  "bKa9NU3sPNHxISTrYOuAOfJgZLuKXpywnHFjkOIvcrk1hu5NFqTcVGj7IGtOO93GU2rNmZqWl9WLSICYQZMZ7tL9Lfnj2AH3bU7JT9C8vbMtIc31FajKbPK81lhCDzSa5G3Y0SkyqwCGWdPfSHXeGR5sbQoWsSoTOhMOXP80hqc="
        dist: debian/stretch
        skip_cleanup: true
        package_glob: signalk-server*.deb
        on:
          all_branches: true
      - provider: packagecloud
        repository: signalk-server
        username: SignalK
        token:
          secure:  "bKa9NU3sPNHxISTrYOuAOfJgZLuKXpywnHFjkOIvcrk1hu5NFqTcVGj7IGtOO93GU2rNmZqWl9WLSICYQZMZ7tL9Lfnj2AH3bU7JT9C8vbMtIc31FajKbPK81lhCDzSa5G3Y0SkyqwCGWdPfSHXeGR5sbQoWsSoTOhMOXP80hqc="
        dist: raspbian/stretch
        skip_cleanup: true
        package_glob: signalk-server*.deb
        on:
          all_branches: true

  - stage: build-deb-main
    if: tag =~ ^v[0-9]
    before_install:
    - npm install -g node-deb
    before_script:
        - "PACKAGE_VERSION=$(cat package.json | grep version | head -1 | awk -F: '{ print $2 }' | sed 's/[\",]//g' | tr -d '[[:space:]]')"
        - node-deb --verbose -n "signalk-server" -v "${PACKAGE_VERSION}" -- index.js `find . -maxdepth 1 -type d | grep -v .git | grep -v node_modules | egrep -v '^\.$'`
    script: ls -lh *.deb ; dpkg-deb --info *.deb
    deploy:
      - provider: packagecloud
        repository: signalk-server
        username: SignalK 
        token:
          secure:  "bKa9NU3sPNHxISTrYOuAOfJgZLuKXpywnHFjkOIvcrk1hu5NFqTcVGj7IGtOO93GU2rNmZqWl9WLSICYQZMZ7tL9Lfnj2AH3bU7JT9C8vbMtIc31FajKbPK81lhCDzSa5G3Y0SkyqwCGWdPfSHXeGR5sbQoWsSoTOhMOXP80hqc="
        dist: debian/stretch
        skip_cleanup: true
        package_glob: signalk-server*.deb
        on:
          branch: master
      - provider: packagecloud
        repository: signalk-server
        username: SignalK
        token:
          secure:  "bKa9NU3sPNHxISTrYOuAOfJgZLuKXpywnHFjkOIvcrk1hu5NFqTcVGj7IGtOO93GU2rNmZqWl9WLSICYQZMZ7tL9Lfnj2AH3bU7JT9C8vbMtIc31FajKbPK81lhCDzSa5G3Y0SkyqwCGWdPfSHXeGR5sbQoWsSoTOhMOXP80hqc="
        dist: raspbian/stretch
        skip_cleanup: true
        package_glob: signalk-server*.deb
        on:
          branch: master
